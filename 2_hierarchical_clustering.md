# Иерархический кластерный анализ

* Кластерный анализ разделяет объекты на группы
	+ объекты внутри группы похожи между собой
	+ объекты из разных групп различаются
* Определение количества групп — часть задачи
* Группы, на которые разбита выборка, называются кластерами

### Методы кластеризации

* **Метод к-средних**
* Самоорганизующиеся карты Кохонена (SOM) – *перестали быть популярными*
* Смесь (нормальных) распределений – *сильная математика, но предполагается что в данных нормальное распределение*
* Методы, использующие непараметрические оценки плотности – *довольно нестабильны*
* **DBSCAN и OPTICS**
* **Иерархический кластерный анализ**
* Разрезание минимального остовного дерева (Minimum spanning tree) – *интереснее для математика, чем для прикладника*

### Использование кластерного анализа

+ Сегментация
+ Сокращение размерности (вместо объектов кластера берется их типичный представитель)
+ Выбросы

### Примеры

* Определение групп потребителей
	+ По данным о покупателях (результаты опроса, поведение на сайте)
	+ выявить и описать/понять рыночные сегменты
	+ выбрать сегменты, которые компания хочет обслуживать.
* Сегментация
	+ Страховая компания разделяет потенциальных клиентов на группы
	+ По результатам кластеризации для разных сегментов определяются оптимальные цены на услуги, оптимальные тарифы
	+ Но ближайшая цель — индивидуальные тарифы («Вы не принимаете лекарства»)
* Потребительские сегменты
	+ Покупателей можно группировать по разным наборам характеристик, например по возрасту, образованию, месту жительства, типу личности, и так далее.
	+ Недостаточно разделить покупателей на сегменты по **одной** (или по каждой) характеристике.
	+ Кластерный анализ разбивает потребителей на «группы со схожими потребностями в отношении конкретного товара или услуги, достаточными ресурсами, а также готовностью и возможностью покупать» учитывая все информативные показатели **одновременно**.
* Товарные группы для рекомендательной системы
	+ На рынке присутствует большой выбор товаров схожего назначения под разными торговыми марками. Надо разбить товары на группы.
	+ Иногда такое разбиение известно. Например, компьютеры бывают «для дома», «для офиса», «серверы» и «специализированные».
	+ Кластерный анализ применяется, если нет классификации, признанной всеми.
	+ Результат будет зависеть от выбранных показателей.

### Идея иерархического кластерного анализа

сведение задачи к геометрической.

* Каждый объект – точка в $R^k$.
* Похожие объекты расположены «близко» друг к другу
* Различающиеся объекты расположены «далеко»
* Скопления точек – кластер.

Расстояние между объектами:
* Евклидово расстояние
* Квадрат Евклидова расстояния
* Блок (Манхеттен, сити-блок)
* и так далее…

*Евклидово расстояние*

Две точки $(x_1, x_2, x_3), (y_1, y_2, y_3)$
$$d_{xy} = \sqrt{(x_1 - y_1)^2 + (x_2 - y_2)^2 + (x_3 - y_3)^2}$$

Квадрат евклидова расстояния не является расстоянием.

*Расстояние  Block (Manhatten, таксиста).*

$$d_{xy} = |x_1 - y_1| + |x_2 - y_2| + |x_3 - y_3|$$

![Расстояние  Block](/images/lect_2/manhaten.png)

*Расстояние Хэмминга*

* Два слова одинаковой длины
* Расстояние - число позиций, в которых соответствующие символы различны
 
* $D(1011101, 1001001) = 2$
* $D(2173896, 2233796) = 3$
* $D(\text{toned}, \text{roses}) = 3$

*Расстояние Sørensen–Dice*

$$Q = \frac{2 \cdot |A \cap B|}{|A| + |B|}$$

**Никакие усилия на подбор расстояния не являются лишними! Лучше потратить время для поиска расстояния, которое будет лучше измерять схожесть в задаче.**

### Расстояние между кластерами

##### Среднее невзвешенное расстояние (Average linkage clustering).

![Среднее невзвешенное расстояние](/images/lect_2/dist_between_cluster_1.png)

На данном примере будет усредняться 25 пар (5 красных и 5 синих)

##### Центроидный метод (Centroid Method).

![Центроидный метод](/images/lect_2/dist_between_cluster_2.png)

+ Вычислительно прост
+ Объем кластера не влияет

+ Дендрограмма может иметь самопересечения

+ Выходит из употребления

##### Метод дальнего соседа, максимального расстояния (Complete linkage clustering).

![Метод дальнего соседа](/images/lect_2/dist_between_cluster_3.png)

##### Метод ближайшего соседа (Single linkage clustering).

![Метод ближайшего соседа](/images/lect_2/dist_between_cluster_4.png)

##### Метод Варда (Ward's method).

+ Предполагается использование квадрата евклидова расстояния, но это требование нарушается (в Python не реализовано)
+ Выявляет шаровые скопления
+ Объяснение в следующей теме «метод k-
средних»

**Начинающем рекомендую:**

– метод Варда - шаровые скопления;

– метод ближнего соседа (Complete linkage clustering) — ленточные кластеры;

– среднее невзвешенное расстояние (Average linkage clustering) - шаровые скопления.

### Алгоритм кластерного анализа

Пусть есть $n$ объектов, тогда будет $n-1$ шагов. 

0 шаг. Каждый объект объявляется кластером.

1 шаг. Находим два ближайших кластера и объединяем их.

2 шаг. Находим два ближайших кластера и объединяем их.

...

$n-1$ шаг. Находим два ближайших кластера и объединяем их.

Итог, 1 кластер, содержащий все объекты, но в какой-то момент мы начинаем объединять кластеры с большим расстоянием друг от друга, поэтому в какой-то момент нужно остановиться, чтоб не объединять непохожие объекты.

Для определения места остановки можно определять дендрограмму. 

#### Построение дендрограммы

![Объекты](/images/lect_2/dendrogramma.png)

Расстояние Манхэттен. Расстояние между кластерами - среднее невзвешенное расстояние. Пример построения ниже на картинке

![Объекты](/images/lect_2/example_hierarchical_clustering_create.png)

Пример графика каменистая осыпь / локоть 

![Объекты](/images/lect_2/scree_plot.png)

#### Участие аналитика

1. Отбор переменных
2. Метод стандартизации
3. Расстояние между кластерами
4. Расстояние между объектами
5. Число кластеров

##### Отбор переменных

Правильный выбор переменных очень важен. Критерием при отборе переменных для анализа является:
+ ясность интерпретации результата,
+ интуиция исследователя.


##### Стандартизация

Правило для новичка: если Вы не знаете, стандартизировать или нет, стандартизируйте.

Стандартизация:  Для каждого столбца.

+ Линейное преобразование

1. Максимальное значение =1, минимальное = 0 (-1)

$$y_{k} = \frac{x_k - x_{min}}{x_{max} - x_{min}}$$

2. z-метки. Среднее равно 0, выборочная дисперсия равна 1.

$$z_k = \frac{x_k - \overline{x_n}} {Sd}$$

Может сработать хорошо и тот, и другой вариант стандартизации. В 80% случаев стандартизация не влияет. Делать с обеими и смотреть лучший вариант.

В модуле preprocessing библиотеки sklearn реализованы несколько классов стандартизации данных:"

+ StandardScaler -- приведение к нулевому среднему и единичной дисперсии.
+ MinMaxScaler -- приведение данных к отрезку [0, 1]
+ MaxAbsScaler -- приведение к [-1, 1] (рекомендуется для разреженных данных).
	
##### Результаты кластерного анализа

Если кластеров нет, они все равно будут найдены. **Кластеров может не быть в данных!!**

Результаты кластерного анализа нуждаются в интерпретации. Какой вариант кластеризации даст лучшие результаты?

+ тот, который вы смогли понять и проинтерпретировать
+ кластерный анализ завершён, когда мы смогли объяснить себе и заказчику, что общего у объектов в кластере и чем различаются объекты из разных кластеров между собой

Иерархический кластерный анализ требует вдохновенного выбора формул для расстояния между объектами и расстояния между кластерами. Еще надо угадать число кластеров. Потом останется неясной геометрия кластеров.
Таким образом, многое надо угадать и осмыслить. Не всегда это удается.

##### Число кластеров

Один из это: Silhoette. Есть и другие метод определения числа кластеров: https://neerc.ifmo.ru/wiki/index.php?title=%D0%9E%D1%86%D0%B5%D0%BD%D0%BA%D0%B0_%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B0_%D0%B2_%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B5_%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8#.D0.A1.D0.B8.D0.BB.D1.83.D1.8D.D1.82_.28.D0.B0.D0.BD.D0.B3.D0.BB._Silhouette.29

##### Типы кластеров

Для шаровых кластеров можно использовать любой метод вычисления расстояний. Для ленточных - метод ближайшего соседа.

Нужно визуализировать кластеры. 

Проецируем точки на плоскость

+ Раскрашиваем точки из разных кластеров
+ Методы: факторный анализ, многомерное шкалирование, ...

